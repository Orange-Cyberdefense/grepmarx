{% extends "base.html" %}

{% block title %} Project dashboard - {{ project.name }} {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
{% endblock stylesheets %}

{% block content %}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Project dashboard - {{ project.name }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
                        <li class="breadcrumb-item active">{{ project.name }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <!-- Main content -->
    <section class="content">

        {% include 'messages.html' %}

        <div class="row">

            <div class="col-12 col-xl-8">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card card-tertiary">
                            <div class="card-header">
                                <h3 class="card-title">Risk level</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse"
                                        title="Collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body" style="height: 12em;">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <div style="height: 8em;">
                                            <div class="h3 text-danger"
                                                style="width: 100%; position: absolute; top: 2.7em; left: 0; margin-top: -20px; line-height:19px; text-align: center; z-index: 999999999999999">
                                                70%
                                            </div>
                                            <canvas id="chart-risk-level-canvas"></canvas>
                                        </div>
                                    </div>

                                    <div class="col-sm-9">
                                        <p class="text-lg">
                                            This application is fairly <strong>insecure.</strong>
                                        </p>
                                        <p class="text-justify pt-0">
                                            Major vulnerabilities may be exploited by an attacker
                                            to gain access to sensitive information or compromize the environment
                                            running the application.
                                        </p>
                                        <div class="btn-group">
                                            <a class="btn btn-default" href="/analysis/workbench/{{ project.analysis.id }}">
                                                <span title="Workbench" class="fas fa-laptop-code"></span>
                                                Workbench
                                            </a>
                                            <a class="btn btn-default" href="/analysis/dependencies/{{ project.appinspector.id }}">
                                                <span title="Dependencies" class="fas fa-sitemap"></span>
                                                Dependencies
                                            </a>
                                            <a class="btn btn-default" href="/analysis/inspector/{{ project.analysis.id }}">
                                                <span title="Inspector" class="fas fa-list"></span>
                                                Inspector
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-4">
                <div class="card card-default">
                    <div class="card-header">
                        <h3 class="card-title">Project information</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="height: 12em;">
                        <div class="row">
                            <div class="col-md-6">
                                <span class="fas fa-file-archive" style="max-width: 25em;"></span>
                                {{ project.archive_filename | truncate(18, True) }}
                            </div>
                            <div class="col-md-6">
                                <span class="fas fa-user"></span>
                                {{ project.creator.username }}
                            </div>
                            <div class="col-md-6">
                                <span class="fas fa-clock"></span>
                                {% set duration = (project.analysis.finished_on - project.analysis.started_on) | string %}
                                Duration: {{ duration.split('.', 2)[0] }}
                            </div>
                            <div class="col-md-6">
                                <span class="fas fa-file-import mr-1"></span>
                                Files: {{ project.project_lines_count.total_file_count }}
                            </div>
                            <div class="col-md-6">
                                <span class="fas fa-code"></span>
                                Code: {{ project.project_lines_count.total_code_count }}
                            </div>
                            <div class="col-md-6">
                                <span class="fas fa-hashtag"></span>
                                Comments: {{ project.project_lines_count.total_comment_count }}
                            </div>
                        </div>
                        <br />
                        <div class="row">
                            {% for c_lang in top_supported_language_lines_counts(project.project_lines_count)[0:4] %}
                            <div class="col-md-6">
                                <span class="{{ lang_icons[c_lang.name] }}"></span>
                                {{ c_lang.name }}: {{ (project.project_lines_count.language_lines_counts | selectattr("language", "equalto",  c_lang.name) | map(attribute='line_count') | list)[0] }}
                            </div>
                                {% endfor %}
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <div class="row">

            <div class="col-12 col-xl-4">
                <div class="card card-default">
                    <div class="card-header">
                        <h3 class="card-title">Vulnerabilities summary</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 17em;">
                            <canvas id="chart-vulnerabilities-canvas"></canvas>
                        </div>
                        <p class="m-0 text-right">
                            <a href="/analysis/workbench/{{ project.analysis.id }}">Browse all vulnerabilities in the workbench &gt;&gt;</a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-4">
                <div class="card card-default">
                    <div class="card-header">
                        <h3 class="card-title">Critical dependencies</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="height: 21em;">
                        <div class="row">
                            <div class="col-sm-12">
                                <table id="vulnerable-deps-table" class="table" role="grid">
                                    <tbody>
                                        {% for c_vuln in (project.analysis.vulnerable_dependencies | sort(attribute='cvss_score', reverse=True))[0:5] %}
                                        <tr>
                                            <td class="align-middle">
                                                {% if c_vuln.severity == "critical" %}
                                                <span class="badge bg-danger p-2">
                                                {% elif c_vuln.severity == "high" %}
                                                <span class="badge bg-orange p-2">
                                                {% elif c_vuln.severity == "medium" %}
                                                <span class="badge bg-warning p-2">
                                                {% else %}
                                                <span class="badge bg-info p-2">
                                                    {% endif %}
                                                    {{ c_vuln.common_id }}
                                                </span>
                                            </td>
                                            <td class="align-middle">
                                                {{ (c_vuln.pkg_name | capitalize + " v" +  c_vuln.version) | truncate(21, True) }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <p class="text-right">
                            <a href="/analysis/dependencies/{{ project.analysis.id }}">Explore all vulnerable dependencies &gt;&gt;</a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-4">
                <div class="card card-default">
                    <div class="card-header">
                        <h3 class="card-title">Main features</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="height: 21em;">
                        <div class="row">
                            <div class="col-sm-12">
                                <table id="vulnerable-deps-table" class="table" role="grid">
                                    <tbody>
                                        {% for c_feature in top_features %}
                                        <tr>
                                            <td class="align-middle">
                                                {{ c_feature.description }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <p class="mt-3 text-right">
                            <a href="/analysis/inspector/{{ project.analysis.id }}">View all features in the inspector &gt;&gt;</a>
                        </p>
                    </div>
                </div>
            </div>

        </div>

    </section>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<!-- ChartJS -->
<script src="/static/assets/plugins/chart.js/chart.min.js"></script>

<script type="text/javascript">

    /**
     * Risk level chart 
     */

    (async function () {
        const data = [
            { type: "Level", percentage: 70 },
            { type: "Padding", percentage: 30 },
        ];

        new Chart(
            document.getElementById('chart-risk-level-canvas'),
            {
                type: 'doughnut',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: 50,
                    plugins: {
                        tooltip: {
                            enabled: false
                        },
                        legend: {
                            display: false,
                        }
                    },
                    backgroundColor: [
                        "#dc3545",
                        "#0000",
                    ],
                },
                data: {
                    labels: data.map(row => row.type),
                    datasets: [
                        {
                            borderWidth: 0,
                            data: data.map(row => row.percentage)
                        }
                    ],
                },
            }
        );
    })();

    /**
     * Vulnerabilities chart 
     */

    (async function () {
        const data = [
            { severity: "Critical", count: 2 },
            { severity: "High", count: 4 },
            { severity: "Medium", count: 7 },
            { severity: "Low", count: 5 },
            { severity: "Information", count: 3 },
        ];

        new Chart(
            document.getElementById('chart-vulnerabilities-canvas'),
            {
                type: 'bar',
                options: {
                    indexAxis: 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    barThickness: 35,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                        }
                    },
                    backgroundColor: [
                        "#dc3545",
                        "#fd7e14",
                        "#ffc107",
                        "#17a2b8",
                        "#3d9970"
                    ],
                    plugins: {
                        tooltip: {
                            enabled: false
                        },
                        legend: {
                            display: false,
                        }
                    }
                },
                data: {
                    labels: data.map(row => row.severity),
                    datasets: [
                        {
                            data: data.map(row => row.count)
                        }
                    ],
                },
            }
        );
    })();

</script>
{% endblock javascripts %}